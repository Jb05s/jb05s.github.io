---
title: "[Under Construction] HEVD Driver Exploitation - Part 3A: Arbitrary Memory Overwrite (Token Stealing)"
date: 2020-10-20
tags: [posts]
excerpt: "Covering another vulnerability in the HackSys HEVD driver - Arbitrary Memory Overwrite"
---
Overview
---
In my last post in this series, I talked about exploiting stack buffer overflows. I highly recommend walking through that [post](https://jb05s.github.io/HEVD-Driver-Exploitation-Part-2-Stack-Overflow-Presented-in-Python-and-C/) to get comfortable with performing driver analysis, if this is your first time attacking Windows kernel drivers.

In this two-part post, I'd like to talk about another vulnerability HackSys implemented into their driver - Arbitrary Memory Overwrite. The first part will start off by covering driver analysis and understanding the vulnerability. Then we'll jump right into building our exploit with the goal of escalating our privileges to `NT Authority\SYSTEM` using the `Token Stealing` technique that was covered in the stack buffer overflow post. 

In the second part of this post I'll walk through another privilege escalation technique - `_SEP_TOKEN_PRIVILEGES`.

Driver Analysis
---
<img src="{{ site.url }}{{ site.baseurl }}/images/hevd-pt3a/ida-irpdeviceiocontrolhandler.png" alt="">

Bug Analysis
---
<img src="{{ site.url }}{{ site.baseurl }}/images/hevd-pt3a/ida-function-search.png" alt="">

<img src="{{ site.url }}{{ site.baseurl }}/images/hevd-pt3a/hevd-amo-code.png" alt="">

<img src="{{ site.url }}{{ site.baseurl }}/images/hevd-pt3a/amo-vuln.png" alt="">

Exploitation - Windows 7 SP1 (x64)
---
Initial exploit code in C:  
<img src="{{ site.url }}{{ site.baseurl }}/images/hevd-pt3a/exploit-c-code-1.png" alt="">

<img src="{{ site.url }}{{ site.baseurl }}/images/hevd-pt3a/windbg-trigger-amo-output.png" alt="">

HalDispatchTable
---

Defeating Address Space Layout Randomization (ASLR)
---

Token Stealing Shellcode - x64
---

ones-and-zer0es
---

Wrapping Up
---